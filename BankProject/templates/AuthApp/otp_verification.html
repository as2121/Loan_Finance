{% extends 'FinanceApp/layout.html' %}
{% load static %}

{% block title %}
<title>Loan Finance - Verify OTP</title>
{% endblock title %}

{% block content %}

<style>
    /* Professional Color Grading */
    .otp-gradient-1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .otp-gradient-2 {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .otp-gradient-3 {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .otp-gradient-4 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    /* Card Styles */
    .otp-card {
        border: none;
        border-radius: 20px;
        transition: all 0.4s ease;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    .otp-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
    }

    /* Header Styles */
    .otp-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-bottom: none;
        padding: 25px 30px;
    }

    .otp-title {
        font-weight: 700;
        font-size: 1.4rem;
        margin: 0;
    }

    /* Form Styles */
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.15);
        background: white;
    }

    /* Button Styles */
    .btn-premium {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-premium:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        color: white;
    }

    .btn-outline-premium {
        border: 2px solid #667eea;
        border-radius: 50px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #667eea;
        background: transparent;
    }

    .btn-outline-premium:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }

    /* Professional Typography */
    .professional-title {
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .professional-subtitle {
        font-weight: 300;
        line-height: 1.6;
        color: #6c757d;
    }

    /* Background Animation */
    .animated-background {
        background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* OTP Input Styles */
    .otp-input {
        width: 55px;
        height: 65px;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .otp-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        transform: scale(1.05);
    }

    .otp-input:valid {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }

    .otp-container {
        gap: 15px;
        margin: 25px 0;
    }

    /* Icon Styles */
    .otp-icon-container {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .otp-icon {
        font-size: 2.5rem;
        color: white;
    }

    /* Message Styles */
    .success-message {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 10px 0;
        font-weight: 600;
    }

    .error-message {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 10px 0;
        font-weight: 600;
    }

    .info-message {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 10px 0;
        font-weight: 600;
    }

    /* Timer Styles */
    .timer-container {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        padding: 10px 15px;
        margin: 15px 0;
    }

    .timer {
        font-weight: 700;
        color: #667eea;
        font-size: 1.1rem;
    }

    /* Resend Button Styles */
    .resend-btn {
        cursor: pointer;
    }

    .resend-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ============================ */
    /* MOBILE RESPONSIVE FIXES */
    /* ============================ */

    /* Mobile-first responsive design */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
        }

        .animated-background {
            padding: 10px !important;
        }

        .row.w-100.justify-content-center {
            margin: 0 !important;
            padding: 0 !important;
        }

        .col-md-6 {
            padding: 0 !important;
            margin: 0 !important;
        }

        .otp-card {
            margin: 0 !important;
            border-radius: 15px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
        }

        .card-body.text-center.p-5 {
            padding: 25px 20px !important;
        }

        .otp-header {
            padding: 20px 15px !important;
        }

        .otp-title {
            font-size: 1.2rem !important;
        }

        /* OTP Input Mobile Fixes */
        .otp-input {
            width: 45px !important;
            height: 55px !important;
            font-size: 1.3rem !important;
            border-radius: 12px !important;
        }

        .otp-container {
            gap: 8px !important;
            margin: 20px 0 !important;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Text and Spacing Mobile Fixes */
        .professional-title {
            font-size: 1.3rem !important;
            margin-bottom: 10px !important;
            line-height: 1.3 !important;
        }

        .professional-subtitle {
            font-size: 0.9rem !important;
            line-height: 1.4 !important;
            margin-bottom: 15px !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        /* Timer Container */
        .timer-container {
            padding: 8px 12px !important;
            margin: 10px 0 !important;
        }

        .timer {
            font-size: 1rem !important;
        }

        /* Button Mobile Fixes */
        .btn-premium {
            padding: 12px 25px !important;
            font-size: 1rem !important;
            width: 100%;
            margin: 5px 0 !important;
        }

        .btn-outline-premium {
            padding: 10px 20px !important;
            font-size: 0.9rem !important;
            width: 100%;
            margin: 5px 0 !important;
        }

        /* Icon Container */
        .otp-icon-container {
            width: 70px !important;
            height: 70px !important;
            margin-bottom: 15px !important;
        }

        .otp-icon {
            font-size: 2rem !important;
        }

        /* Additional Info Section */
        .mt-5.pt-4.border-top {
            margin-top: 2rem !important;
            padding-top: 1.5rem !important;
        }

        .row.text-center .col-4 {
            padding: 0 5px !important;
        }

        .fa-lg {
            font-size: 1.3rem !important;
        }

        .small {
            font-size: 0.75rem !important;
        }

        /* Message Styles */
        .success-message,
        .error-message,
        .info-message {
            padding: 8px 12px !important;
            margin: 8px 0 !important;
            font-size: 0.85rem !important;
        }
    }

    @media (max-width: 576px) {
        .card-body.text-center.p-5 {
            padding: 20px 15px !important;
        }

        .otp-header {
            padding: 15px 12px !important;
        }

        .otp-title {
            font-size: 1.1rem !important;
        }

        .otp-input {
            width: 40px !important;
            height: 50px !important;
            font-size: 1.2rem !important;
            border-radius: 10px !important;
        }

        .otp-container {
            gap: 6px !important;
            margin: 15px 0 !important;
        }

        .professional-title {
            font-size: 1.2rem !important;
        }

        .professional-subtitle {
            font-size: 0.85rem !important;
        }

        .otp-icon-container {
            width: 60px !important;
            height: 60px !important;
        }

        .otp-icon {
            font-size: 1.8rem !important;
        }

        .timer-container {
            padding: 6px 10px !important;
        }

        .timer {
            font-size: 0.9rem !important;
        }
    }

    @media (max-width: 400px) {
        .otp-input {
            width: 35px !important;
            height: 45px !important;
            font-size: 1.1rem !important;
        }

        .otp-container {
            gap: 4px !important;
        }

        .professional-title {
            font-size: 1.1rem !important;
        }

        .professional-subtitle {
            font-size: 0.8rem !important;
        }

        .otp-icon-container {
            width: 55px !important;
            height: 55px !important;
        }

        .otp-icon {
            font-size: 1.6rem !important;
        }

        .btn-premium {
            padding: 10px 20px !important;
            font-size: 0.9rem !important;
        }

        .card-body.text-center.p-5 {
            padding: 15px 10px !important;
        }
    }

    @media (max-width: 360px) {
        .otp-input {
            width: 32px !important;
            height: 42px !important;
            font-size: 1rem !important;
        }

        .otp-container {
            gap: 3px !important;
        }

        .professional-title {
            font-size: 1rem !important;
        }

        .otp-icon-container {
            width: 50px !important;
            height: 50px !important;
            margin-bottom: 10px !important;
        }

        .otp-icon {
            font-size: 1.4rem !important;
        }
    }

    /* Ensure touch-friendly elements */
    .otp-input,
    .btn-premium,
    .btn-outline-premium {
        min-height: 44px;
    }

    /* Prevent horizontal scrolling */
    body {
        overflow-x: hidden;
    }

    .container-fluid {
        max-width: 100%;
        overflow-x: hidden;
    }

    /* Loading Animation */
    .loading-dots {
        display: inline-block;
    }

    .loading-dots::after {
        content: '';
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60% { content: '...'; }
        80%, 100% { content: ''; }
    }
</style>

<div class="container-fluid animated-background" style="min-height: 100vh; display: flex; align-items: center;">
  <div class="row w-100 justify-content-center">
    <div class="col-md-6">
      <div class="otp-card" data-aos="zoom-in" data-aos-duration="800">
        <!-- Header -->
        <div class="otp-header text-white text-center">
          <h5 class="otp-title mb-0">
            <i class="fas fa-shield-alt me-2"></i>Verify Your Identity
          </h5>
        </div>

        <!-- Body -->
        <div class="card-body text-center p-5">
          <!-- Icon and Message -->
          <div class="mb-4">
            <div class="otp-icon-container">
              <i class="fas fa-envelope otp-icon"></i>
            </div>
            <h4 class="professional-title text-dark mb-3">Enter Verification Code</h4>
            <p class="professional-subtitle">
              We've sent a 6-digit security code to your email address
            </p>
            <!-- Timer Display -->
            <div class="timer-container">
              <p class="mb-1"><small>Code expires in:</small></p>
              <div class="timer" id="countdown">1:01</div>
            </div>
          </div>

          <!-- OTP Form -->
          <form method="post" action="/finance/verify-otp/" novalidate id="otpForm">
            {% csrf_token %}
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="otp" id="otp">

            <!-- OTP Inputs -->
            <div class="d-flex justify-content-center otp-container">
              <input type="password" maxlength="1" name="otp1" class="otp-input form-control" required autocomplete="off">
              <input type="password" maxlength="1" name="otp2" class="otp-input form-control" required autocomplete="off">
              <input type="password" maxlength="1" name="otp3" class="otp-input form-control" required autocomplete="off">
              <input type="password" maxlength="1" name="otp4" class="otp-input form-control" required autocomplete="off">
              <input type="password" maxlength="1" name="otp5" class="otp-input form-control" required autocomplete="off">
              <input type="password" maxlength="1" name="otp6" class="otp-input form-control" required autocomplete="off">
            </div>

            <!-- OTP Message -->
            <div id="otp_message" class="text-center mb-4">
              {% if messages %}
                {% for message in messages %}
                  {% if message.tags == 'success' %}
                    <div class="success-message">{{ message }}</div>
                  {% elif message.tags == 'error' %}
                    <div class="error-message">{{ message }}</div>
                  {% else %}
                    <div class="info-message">{{ message }}</div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center align-items-center mt-4">
              <button type="submit" class="btn-premium" id="verifyBtn">
                Verify <i class="fas fa-check ms-1"></i>
              </button>
            </div>
          </form>

          <!-- Additional Info -->
          <div class="mt-5 pt-4 border-top">
            <div class="row text-center">
              <div class="col-4">
                <div class="text-primary">
                  <i class="fas fa-lock fa-lg mb-2"></i>
                  <p class="small mb-0">Secure</p>
                </div>
              </div>
              <div class="col-4">
                <div class="text-success">
                  <i class="fas fa-bolt fa-lg mb-2"></i>
                  <p class="small mb-0">Fast</p>
                </div>
              </div>
              <div class="col-4">
                <div class="text-info">
                  <i class="fas fa-clock fa-lg mb-2"></i>
                  <p class="small mb-0">1 min Expiry</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const otpInputs = document.querySelectorAll('.otp-input');
    const otpField = document.getElementById('otp');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const resendTimer = document.getElementById('resendTimer');
    const otpMessage = document.getElementById('otp_message');
    const countdown = document.getElementById('countdown');
    let resendCountdown = 30; // 30 seconds before resend is allowed
    let otpCountdown = 60; // 10 minutes for OTP expiry

    // Start OTP expiry timer
    function startOtpTimer(duration, display) {
        let timer = duration, minutes, seconds;
        const timerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(timerInterval);
                display.textContent = "00:00";
                otpMessage.innerHTML = '<div class="error-message">OTP has expired. Please request a new one.</div>';
            }
        }, 1000);
    }

    // Start resend countdown
    function startResendTimer() {
        resendBtn.disabled = true;
        resendBtn.classList.add('disabled');
        resendCountdown = 30; // Reset to 60 seconds

        const timerInterval = setInterval(function() {
            resendTimer.textContent = `(${resendCountdown}s)`;

            if (resendCountdown <= 0) {
                clearInterval(timerInterval);
                resendBtn.disabled = false;
                resendBtn.classList.remove('disabled');
                resendTimer.textContent = '';
            }

            resendCountdown--;
        }, 1000);
    }

    // Initialize timers
    if (countdown) {
        startOtpTimer(otpCountdown, countdown);
    }
    if (resendBtn && resendTimer) {
        startResendTimer();
    }

    // Auto-focus and OTP management
    if (otpInputs.length > 0) {
        otpInputs.forEach((input, index) => {
            // Auto-focus first input
            if (index === 0) {
                setTimeout(() => input.focus(), 100);
            }

            // Handle input
            input.addEventListener('input', (e) => {
                const value = e.target.value;

                // Only allow numbers
                if (!/^\d*$/.test(value)) {
                    e.target.value = '';
                    return;
                }

                // Move to next input if current is filled
                if (value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }

                // Update hidden OTP field
                updateOtpField();
            });

            // Handle backspace
            input.addEventListener('keydown', (e) => {
                if (e.key === "Backspace" && input.value === "" && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });

            // Handle paste
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text').slice(0, 6);
                pasteData.split('').forEach((char, i) => {
                    if (otpInputs[i] && /^\d$/.test(char)) {
                        otpInputs[i].value = char;
                    }
                });
                updateOtpField();
                if (pasteData.length < 6) {
                    otpInputs[pasteData.length].focus();
                } else {
                    otpInputs[5].focus();
                }
            });
        });
    }

    function updateOtpField() {
        if (otpField && otpInputs.length > 0) {
            otpField.value = Array.from(otpInputs).map(i => i.value).join('');
        }
    }

    // Form submission handling
    const otpForm = document.getElementById('otpForm');
    if (otpForm) {
        otpForm.addEventListener('submit', function(e) {
            const otp = otpField ? otpField.value : '';

            if (otp.length !== 6) {
                e.preventDefault();
                if (otpMessage) {
                    otpMessage.innerHTML = '<div class="error-message">Please enter complete 6-digit OTP!</div>';
                }
                if (otpInputs.length > 0) {
                    otpInputs[0].focus();
                }
                return;
            }

            // Show loading state
            if (verifyBtn) {
                const originalText = verifyBtn.innerHTML;
                verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying<span class="loading-dots"></span>';
                verifyBtn.disabled = true;

                // Re-enable after 5 seconds in case of error
                setTimeout(() => {
                    verifyBtn.innerHTML = originalText;
                    verifyBtn.disabled = false;
                }, 5000);
            }
        });
    }
});
</script>

<!-- AOS Animation -->
<link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 1000,
    once: true,
    offset: 50
  });
</script>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

{% endblock %}