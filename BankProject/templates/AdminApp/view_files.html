{% extends 'AdminApp/layout.html' %}

{% block content %}
<style>
    /* Professional Color Grading */
    .admin-gradient-1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .admin-gradient-2 {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .admin-gradient-3 {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .admin-gradient-4 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    /* Card Styles */
    .detail-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
        background: white;
        margin-bottom: 25px;
    }

    .detail-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 25px;
        border-bottom: none;
    }

    .detail-body {
        padding: 25px;
    }

    /* Section Headers */
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px 10px 0 0;
        margin-bottom: 20px;
    }

    .section-title {
        font-weight: 600;
        font-size: 1.3rem;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .section-title i {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    /* Detail Items */
    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 15px 0;
        border-bottom: 1px solid #f1f3f4;
        transition: all 0.3s ease;
    }

    .detail-item:hover {
        background: rgba(102, 126, 234, 0.05);
        padding-left: 10px;
        padding-right: 10px;
        border-radius: 8px;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
        font-size: 0.95rem;
    }

    .detail-value {
        flex: 2;
        color: #5a6c7d;
        font-weight: 500;
        text-align: right;
    }

    .detail-value b {
        color: #2c3e50;
        font-weight: 600;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-pending {
        background: linear-gradient(135deg, #feca57, #ff9ff3);
        color: #2c3e50;
    }

    .status-approved {
        background: linear-gradient(135deg, #43e97b, #38f9d7);
        color: white;
    }

    .status-rejected {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
    }

    /* Button Styles */
    .action-btn {
        border: none;
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
        margin: 0 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-approve {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    .btn-approve:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(67, 233, 123, 0.3);
        color: white;
    }

    .btn-reject {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 1rem;
        margin: 0 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .btn-reject:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        color: white;
    }

    /* File Links */
    .file-link {
        display: inline-flex;
        align-items: center;
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 8px 15px;
        border-radius: 8px;
        background: rgba(102, 126, 234, 0.1);
    }

    .file-link:hover {
        color: #764ba2;
        background: rgba(102, 126, 234, 0.2);
        text-decoration: none;
        transform: translateY(-2px);
    }

    .file-link i {
        margin-right: 8px;
        font-size: 1rem;
    }

    /* Reject Modal Styles */
    .reject-modal .modal-content {
        border: none;
        border-radius: 15px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .reject-modal .modal-header {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        border-bottom: none;
        padding: 20px 25px;
    }

    .reject-modal .modal-title {
        font-weight: 700;
        font-size: 1.3rem;
        color: white;
    }

    .reject-modal .modal-body {
        padding: 25px;
    }

    .reject-modal .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 20px 25px;
    }

    .reject-modal .form-control:focus {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 0.2rem rgba(255, 107, 107, 0.25);
    }

    .application-info {
        border-left: 4px solid #ff6b6b;
        background: rgba(255, 107, 107, 0.05);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .detail-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-value {
            text-align: left;
            margin-top: 5px;
            width: 100%;
        }

        .action-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
        }

        .detail-body {
            padding: 20px 15px;
        }

        .section-header {
            padding: 12px 15px;
        }

        /* Mobile Modal Fixes */
        .reject-modal .modal-dialog {
            margin: 20px;
            max-width: calc(100% - 40px);
        }

        .reject-modal .modal-header {
            padding: 15px 20px;
        }

        .reject-modal .modal-body {
            padding: 20px;
        }

        .reject-modal .modal-footer {
            padding: 15px 20px;
            flex-direction: column;
            gap: 10px;
        }

        .reject-modal .modal-footer .btn {
            width: 100%;
            margin: 2px 0;
        }
    }

    @media (max-width: 576px) {
        .reject-modal .modal-dialog {
            margin: 10px;
            max-width: calc(100% - 20px);
        }

        .reject-modal .modal-header {
            padding: 12px 15px;
        }

        .reject-modal .modal-body {
            padding: 15px;
        }

        .reject-modal .modal-title {
            font-size: 1.1rem;
        }
    }

    /* Loading Animation */
    .loading-dots {
        display: inline-block;
    }

    .loading-dots::after {
        content: '';
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60% { content: '...'; }
        80%, 100% { content: ''; }
    }

    /* Background Animation */
    .animated-background {
        background: linear-gradient(-45deg, #f8f9fa, #e9ecef, #f8f9fa, #e9ecef);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        min-height: 100vh;
    }

    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
</style>

<div class="container-fluid animated-background py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Main Header Card -->
            <div class="detail-card">
                <div class="detail-header text-center">
                    <h1 class="mb-2">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Loan File Details
                    </h1>
                    <p class="mb-0 opacity-75">Complete customer and loan application information</p>
                </div>

                <div class="detail-body">
                    <!-- Customer & Application Info -->
                    <div class="row">
                        <!-- Customer Details Column -->
                        <div class="col-md-6 mb-4">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-user-circle"></i>
                                    Customer Details
                                </h3>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">User ID</span>
                                <span class="detail-value"><b>{{loan_object.user_id}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Username</span>
                                <span class="detail-value"><b>{{loan_object.user_name}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Full Name</span>
                                <span class="detail-value"><b>{{loan_object.customer_name}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Mobile</span>
                                <span class="detail-value"><b>{{loan_object.customer_mobile}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Email</span>
                                <span class="detail-value"><b>{{loan_object.customer_email}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Address</span>
                                <span class="detail-value"><b>{{loan_object.customer_address}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Aadhar Number</span>
                                <span class="detail-value"><b>{{loan_object.adhar_number}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">PAN Number</span>
                                <span class="detail-value"><b>{{loan_object.pan_number}}</b></span>
                            </div>
                        </div>

                        <!-- Loan Details Column -->
                        <div class="col-md-6 mb-4">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-hand-holding-usd"></i>
                                    Loan Information
                                </h3>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Loan Type</span>
                                <span class="detail-value"><b>{{loan_object.loan_type}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Interest Rate</span>
                                <span class="detail-value"><b>{{loan_object.interest}}%</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Request Amount</span>
                                <span class="detail-value"><b>&#8377; {{loan_object.request_amount}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Installment Period</span>
                                <span class="detail-value"><b>{{loan_object.month_installation}} Months</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Application Date</span>
                                <span class="detail-value"><b>{{loan_object.action}}</b></span>
                            </div>

                            <div class="detail-item">
                                <span class="detail-label">Status</span>
                                <span class="detail-value">
                                    {% if loan_object.status == 'pending' %}
                                        <span class="status-badge status-pending">{{loan_object.status}}</span>
                                    {% elif loan_object.status == 'approved' %}
                                        <span class="status-badge status-approved">{{loan_object.status}}</span>
                                    {% else %}
                                        <span class="status-badge status-rejected">{{loan_object.status}}</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Document Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="section-header">
                                <h3 class="section-title">
                                    <i class="fas fa-file-contract"></i>
                                    Supporting Documents
                                </h3>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="detail-item">
                                        <span class="detail-label">Customer Photo</span>
                                        <span class="detail-value">
                                            <a href="{{loan_object.customer_photo.url}}" target="_blank" class="file-link">
                                                <i class="fas fa-external-link-alt"></i>View Photo
                                            </a>
                                        </span>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <div class="detail-item">
                                        <span class="detail-label">PAN Card</span>
                                        <span class="detail-value">
                                            <a href="{{loan_object.customer_pan_card.url}}" target="_blank" class="file-link">
                                                <i class="fas fa-external-link-alt"></i>View PAN Card
                                            </a>
                                        </span>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <div class="detail-item">
                                        <span class="detail-label">Aadhar Card</span>
                                        <span class="detail-value">
                                            <a href="{{loan_object.customer_adhar.url}}" target="_blank" class="file-link">
                                                <i class="fas fa-external-link-alt"></i>View Aadhar Card
                                            </a>
                                        </span>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <div class="detail-item">
                                        <span class="detail-label">Signature</span>
                                        <span class="detail-value">
                                            <a href="{{loan_object.customer_signature.url}}" target="_blank" class="file-link">
                                                <i class="fas fa-external-link-alt"></i>View Signature
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-5">
                        <div class="col-12 text-center">
                            {% if loan_object.status == 'pending' %}
                            <a href="/FinanceAdmin/approve/{{loan_object.id}}">
                                <button class="btn action-btn btn-approve">
                                    <i class="fas fa-check-circle mr-2"></i>Approve File
                                </button>
                            </a>
                            {% endif %}

                            {% if loan_object.status == 'pending' or loan_object.status == 'approved' %}
                            <button type="button" class="btn action-btn btn-reject" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                <i class="fas fa-times-circle mr-2"></i>Reject File
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade reject-modal" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Reject Loan Application
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="/FinanceAdmin/reject/" id="rejectForm">
                {% csrf_token %}
                <input name="id" value="{{loan_object.id}}" hidden>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. The applicant will be notified via email.
                    </div>

                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label fw-bold">
                            <i class="fas fa-comment-dots me-2"></i>Rejection Reason *
                        </label>
                        <textarea
                            class="form-control"
                            id="rejectionReason"
                            name="rejection_reason"
                            rows="4"
                            placeholder="Please provide the reason for rejecting this loan application..."
                            required
                            maxlength="500"></textarea>
                        <div class="form-text">
                            <span id="charCount">0</span>/500 characters
                        </div>
                    </div>

                    <div class="application-info bg-light p-3 rounded">
                        <h6 class="fw-bold mb-3">Application Details:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>Applicant:</strong> {{loan_object.customer_name}}</small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Amount:</strong> ₹{{loan_object.request_amount}}</small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Loan Type:</strong> {{loan_object.loan_type}}</small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Application ID:</strong> {{loan_object.id}}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-danger" id="confirmRejectBtn">
                        <i class="fas fa-ban me-2"></i>Confirm Rejection
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rejectForm = document.getElementById('rejectForm');
    const rejectionReason = document.getElementById('rejectionReason');
    const charCount = document.getElementById('charCount');
    const confirmRejectBtn = document.getElementById('confirmRejectBtn');

    // Character count for rejection reason
    rejectionReason.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = length;

        if (length > 450) {
            charCount.className = 'text-warning fw-bold';
        } else if (length > 400) {
            charCount.className = 'text-warning';
        } else {
            charCount.className = 'text-muted';
        }
    });

    // Form submission handling
    rejectForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const reason = rejectionReason.value.trim();
        if (!reason) {
            showAlert('Please provide a rejection reason.', 'error');
            rejectionReason.focus();
            return;
        }

        if (reason.length < 10) {
            showAlert('Please provide a more detailed rejection reason (minimum 10 characters).', 'error');
            rejectionReason.focus();
            return;
        }

        // Show loading state
        const originalText = confirmRejectBtn.innerHTML;
        confirmRejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        confirmRejectBtn.disabled = true;

        // Submit the form
        this.submit();
    });

    // Reset form when modal is hidden
    const rejectModal = document.getElementById('rejectModal');
    rejectModal.addEventListener('hidden.bs.modal', function() {
        rejectForm.reset();
        charCount.textContent = '0';
        charCount.className = 'text-muted';
        confirmRejectBtn.innerHTML = '<i class="fas fa-ban me-2"></i>Confirm Rejection';
        confirmRejectBtn.disabled = false;
    });

    // Alert function
    function showAlert(message, type) {
        // You can replace this with a more sophisticated alert system
        alert(message);
    }
});
</script>

{% endblock %}